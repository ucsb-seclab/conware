#!/usr/bin/env python

# Native
import argparse
import fnmatch
import os
import sys
import logging

# Conware
from conware.model import PretenderModel
from conware import *

logger = logging.getLogger(__name__)

if __name__ == "__main__":
    # Default argument values
    sample = "bins/Nucleo_blink_led.bin"
    openocd_conf = '/usr/share/openocd/scripts/board/st_nucleo_l1.cfg'
    output_dir = '/tmp/myavatar'
    qemu_executable = "../../avatar-pretender/targets/build/qemu/arm-softmmu/qemu-system-arm"
    gdb_port = 1235
    qemu_port = 23454

    # Get user input
    parser = argparse.ArgumentParser()
    parser.add_argument("recording_dir", default="recording",
                        help="Directory containing all of the log files")
    parser.add_argument("--debug", "-d", default=False, action='store_true',
                        help="Enable debug output.")
    args = parser.parse_args()

    if not os.path.exists(args.recording_dir):
        parser.print_help()
        sys.exit(0)

    # Setup Logging
    if args.debug:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.INFO)

    # First, let's just read our log into a nice internal structure
    files = fnmatch.filter(os.listdir(args.recording_dir),
                           "*.%s" % RECORDING_EXTENSION)

    if len(files) != 1:
        logger.error("It looks like there is less than or more than 1 "
                     "recording "
                     "in the given directory!")
        parser.print_help()
        sys.exit(0)

    for f in files:
        logger.info("Opening %s..." % f)
        p = PretenderModel()
        p.train(os.path.join(args.recording_dir, f))
        output_model = os.path.join(args.recording_dir, MODEL_FILE)
        print "Saving model (%s)..." % output_model
        p.save(output_model)
